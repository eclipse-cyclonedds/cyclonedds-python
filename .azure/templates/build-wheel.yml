#
# Copyright(c) 2021 ADLINK Technology Limited and others
#
# This program and the accompanying materials are made available under the
# terms of the Eclipse Public License v. 2.0 which is available at
# http://www.eclipse.org/legal/epl-2.0, or the Eclipse Distribution License
# v. 1.0 which is available at
# http://www.eclipse.org/org/documents/edl-v10.php.
#
# SPDX-License-Identifier: EPL-2.0 OR BSD-3-Clause
#

#
# cibuildwheel + delvewheel CycloneDDS binaries
#


variables:
  CIBW_BUILD_VERBOSITY: 1
  CIBW_BEFORE_BUILD: "pip install delvewheel==0.0.12"
  CIBW_TEST_REQUIRES: pytest==6.2.2
  CIBW_TEST_SKIP: "*-macosx_arm64 *-macosx_universal2:arm64"
  CIBW_REPAIR_WHEEL_COMMAND_LINUX: "delvewheel repair --wheel_dir {dest_dir} {wheel} --add-dll libdds_security_ac.so,libbdds_security_auth.so,libdds_security_crypto.so"
  CIBW_REPAIR_WHEEL_COMMAND_MACOS: "delvewheel repair --wheel_dir {dest_dir} {wheel} --add-dll dds_security_ac.dylib,dds_security_auth.dylib,dds_security_crypto.dylib"
  CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: "delvewheel repair --wheel_dir {dest_dir} {wheel} --add-dll dds_security_ac.dll,dds_security_auth.dll,dds_security_crypto.dll"
  CIBW_SKIP: pp*  # No PyPy builds
  CIBW_ARCHS_MACOS: "x86_64 universal2 arm64"
  CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
  CIBW_MANYLINUX_I686_IMAGE: manylinux2014
  CIBW_TEST_COMMAND: pytest {project}/src/cyclonedds/tests
  CIBW_BEFORE_ALL: mkdir {package}/build {package}/install && cd {package}/build && cmake {package}/cyclonedds -DCMAKE_INSTALL_PREFIX={package}/install -DBUILD_IDLC=0 && \
                   cmake --build . --target install
  CIBW_ENVIRONMENT: "PATH=\"$PATH:{package}/install/lib:{package}/install/bin\" CYCLONEDDS_HOME={package}/install \
                     LIBRARY_PATH=\"$LIBRARY_PATH:{package}/install/lib:{package}/install/bin\" \
                     LD_LIBRARY_PATH=\"$LD_LIBRARY_PATH:{package}/install/lib:{package}/install/bin\""


steps:
  - bash: |
      git clone https://github.com/eclipse-cyclonedds/cyclonedds.git
    name: clone_cyclone
    displayName: Clone the CycloneDDS repository
  - task: UsePythonVersion@0
  - bash: |
      set -o errexit
      python3 -m pip install --upgrade pip
      pip3 install cibuildwheel==1.11.1.post1
    displayName: Install dependencies
  - bash: cibuildwheel --output-dir wheelhouse .
    displayName: Build wheels
  - task: PublishBuildArtifacts@1
    inputs: {pathtoPublish: 'wheelhouse'}
